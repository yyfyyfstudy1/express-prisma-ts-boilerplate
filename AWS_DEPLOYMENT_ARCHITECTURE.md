# AWS ECS éƒ¨ç½²æ¶æ„ï¼ˆç²¾ç®€ç‰ˆï¼‰

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„å›¾

```
                        Internet (ç”¨æˆ·è®¿é—®)
                               â”‚
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   API Gateway       â”‚  â† æ‚¨çš„æµ‹è¯•å…¥å£
                    â”‚   REST API          â”‚     https://xxx.execute-api.us-east-1.amazonaws.com/prod
                    â”‚   - é™æµ            â”‚
                    â”‚   - è®¤è¯            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    AWS VPC (10.0.0.0/16)               â”‚
    â”‚                                                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  â”‚   Application Load Balancer (ALB)           â”‚     â”‚
    â”‚  â”‚   - Health Check: /api/info                 â”‚     â”‚
    â”‚  â”‚   - Port: 80 â†’ 3344                         â”‚     â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    â”‚                 â”‚                                     â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
    â”‚    â”‚   Public Subnet         â”‚                       â”‚
    â”‚    â”‚   10.0.1.0/24           â”‚                       â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
    â”‚                                                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚         ECS Cluster (Fargate)                â”‚    â”‚
    â”‚  â”‚                                              â”‚    â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
    â”‚  â”‚  â”‚  ECS Task 1    â”‚  â”‚  ECS Task 2    â”‚    â”‚    â”‚
    â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚    â”‚
    â”‚  â”‚  â”‚  â”‚Express APIâ”‚  â”‚  â”‚  â”‚Express APIâ”‚  â”‚    â”‚    â”‚
    â”‚  â”‚  â”‚  â”‚Port: 3344 â”‚  â”‚  â”‚  â”‚Port: 3344 â”‚  â”‚    â”‚    â”‚
    â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚    â”‚
    â”‚  â”‚  â”‚  Private Subnetâ”‚  â”‚  Private Subnetâ”‚    â”‚    â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                        â”‚                             â”‚
    â”‚                        â”‚                             â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
    â”‚              â”‚  RDS PostgreSQL   â”‚                   â”‚
    â”‚              â”‚  Port: 5432       â”‚                   â”‚
    â”‚              â”‚  Private Subnet   â”‚                   â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
    â”‚                                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”¯æŒæœåŠ¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ECR (é•œåƒ)  â”‚  â”‚ CloudWatch   â”‚  â”‚ Secrets Mgr â”‚
â”‚ å­˜å‚¨ Docker â”‚  â”‚ æ—¥å¿—å’Œç›‘æ§    â”‚  â”‚ æ•°æ®åº“å¯†ç    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ç»„ä»¶è¯´æ˜

### 1ï¸âƒ£ **API Gateway**
```
ç±»å‹: REST API
ç”¨é€”: 
  - ç»Ÿä¸€å…¥å£ï¼Œæ‚¨ç›´æ¥ç”¨è¿™ä¸ªURLæµ‹è¯•
  - å†…ç½®é™æµä¿æŠ¤
  - å¯é€‰çš„ API Key è®¤è¯
  
é›†æˆæ–¹å¼: HTTP Proxy
  - è½¬å‘æ‰€æœ‰è¯·æ±‚åˆ° ALB
  
æµ‹è¯• URL: 
  https://abc123.execute-api.us-east-1.amazonaws.com/prod/api/info
```

---

### 2ï¸âƒ£ **ALB (åº”ç”¨è´Ÿè½½å‡è¡¡å™¨)**
```
ç”¨é€”:
  - è´Ÿè½½å‡è¡¡ï¼ˆåˆ†å‘è¯·æ±‚åˆ°å¤šä¸ª ECS ä»»åŠ¡ï¼‰
  - å¥åº·æ£€æŸ¥ï¼ˆè‡ªåŠ¨å‰”é™¤ä¸å¥åº·çš„å®¹å™¨ï¼‰
  
ç›‘å¬:
  - Port 80 (HTTP)
  
ç›®æ ‡ç»„:
  - ECS Tasks (Port 3344)
  
å¥åº·æ£€æŸ¥:
  - Path: /api/info
  - Interval: 30s
  - Timeout: 5s
```

---

### 3ï¸âƒ£ **VPC (è™šæ‹Ÿç§æœ‰äº‘)**
```
CIDR: 10.0.0.0/16

å­ç½‘é…ç½®:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Public Subnet (10.0.1.0/24)             â”‚
  â”‚ - ALB                                   â”‚
  â”‚ - NAT Gateway                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Private Subnet - App (10.0.10.0/24)     â”‚
  â”‚ - ECS Tasks                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Private Subnet - DB (10.0.20.0/24)      â”‚
  â”‚ - RDS PostgreSQL                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨ç»„:
  - ALB SG:  å…è®¸ 80 from 0.0.0.0/0
  - ECS SG:  å…è®¸ 3344 from ALB SG
  - RDS SG:  å…è®¸ 5432 from ECS SG
```

---

### 4ï¸âƒ£ **ECS (å®¹å™¨æœåŠ¡)**
```
Cluster: api-cluster
Service: api-service
  - Launch Type: Fargate (æ— éœ€ç®¡ç†æœåŠ¡å™¨)
  - Desired Count: 2
  - CPU: 512 (0.5 vCPU)
  - Memory: 1024 MB
  - é•œåƒ: {account}.dkr.ecr.us-east-1.amazonaws.com/api:latest
  
å®¹å™¨é…ç½®:
  - Port: 3344
  - ç¯å¢ƒå˜é‡: ä» Secrets Manager æ³¨å…¥
  - æ—¥å¿—: CloudWatch Logs
```

---

## ğŸš€ è¯·æ±‚æµç¨‹

```
ç”¨æˆ·
  â†“
https://abc123.execute-api.us-east-1.amazonaws.com/prod/api/info
  â†“
API Gateway (é™æµã€è®¤è¯)
  â†“
ALB (è´Ÿè½½å‡è¡¡)
  â†“
ECS Task 1 æˆ– Task 2 (Express API)
  â†“
RDS PostgreSQL
  â†“
è¿”å›å“åº”
```

---

## ğŸ“ Terraform æ–‡ä»¶ç»“æ„ï¼ˆç²¾ç®€ç‰ˆï¼‰

```
terraform/
â”œâ”€â”€ main.tf                    # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€ VPC èµ„æº
â”‚   â”œâ”€ ALB èµ„æº
â”‚   â”œâ”€ ECS èµ„æº
â”‚   â”œâ”€ API Gateway èµ„æº
â”‚   â””â”€ RDS èµ„æº
â”‚
â”œâ”€â”€ variables.tf               # å˜é‡å®šä¹‰
â”œâ”€â”€ outputs.tf                 # è¾“å‡ºï¼ˆAPI Gateway URLç­‰ï¼‰
â”œâ”€â”€ terraform.tfvars           # å˜é‡å€¼
â””â”€â”€ backend.tf                 # State å­˜å‚¨é…ç½®
```

---

## ğŸ’° æˆæœ¬ä¼°ç®—ï¼ˆç²¾ç®€ç‰ˆï¼‰

```
ECS Fargate (2 tasks):        ~$30/æœˆ
RDS db.t3.micro:              ~$15/æœˆ
ALB:                          ~$20/æœˆ
NAT Gateway:                  ~$45/æœˆ
API Gateway:                  ~$3.5/æœˆ (æ¯ç™¾ä¸‡è¯·æ±‚)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:                         ~$113/æœˆ
```

---

## ğŸ¯ éƒ¨ç½²åçš„è®¿é—®æ–¹å¼

### **API Gateway URLï¼ˆæ‚¨çš„æµ‹è¯•åœ°å€ï¼‰:**
```bash
# åŸºç¡€ URL
https://abc123.execute-api.us-east-1.amazonaws.com/prod

# æµ‹è¯•æ¥å£
curl https://abc123.execute-api.us-east-1.amazonaws.com/prod/api/info

# ç™»å½•
curl -X POST \
  https://abc123.execute-api.us-east-1.amazonaws.com/prod/api/client/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'

# è·å–å¤„æ–¹
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://abc123.execute-api.us-east-1.amazonaws.com/prod/api/client/prescription
```

---

## ğŸ“ éƒ¨ç½²æ­¥éª¤ï¼ˆç®€åŒ–ï¼‰

### **1. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ**
```bash
# æ„å»ºé•œåƒ
docker build -t api:latest .

# æ¨é€åˆ° ECR
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin {account}.dkr.ecr.us-east-1.amazonaws.com
docker tag api:latest {account}.dkr.ecr.us-east-1.amazonaws.com/api:latest
docker push {account}.dkr.ecr.us-east-1.amazonaws.com/api:latest
```

### **2. è¿è¡Œ Terraform**
```bash
cd terraform/
terraform init
terraform plan
terraform apply -auto-approve
```

### **3. è·å– API Gateway URL**
```bash
terraform output api_gateway_url
```

### **4. æµ‹è¯•**
```bash
curl $(terraform output -raw api_gateway_url)/api/info
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æˆ‘ç°åœ¨ä¸ºæ‚¨åˆ›å»ºï¼š
1. âœ… **Dockerfile** (å¤šé˜¶æ®µæ„å»º)
2. âœ… **Terraform ä»£ç ** (ç²¾ç®€ç‰ˆï¼ŒåªåŒ…å«4ä¸ªæ ¸å¿ƒç»„ä»¶)
3. âœ… **éƒ¨ç½²è„šæœ¬** (ä¸€é”®éƒ¨ç½²)

å¼€å§‹åˆ›å»ºï¼ŸğŸš€
